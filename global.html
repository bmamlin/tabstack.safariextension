<!DOCTYPE HTML>
<html>
<head>
   <title>global page</title>
   <script type="text/javascript">

// Delay setting (in milliseconds)
var delay = parseInt(safari.extension.settings.delay);

// Number of tabs which shouldn't be moved
var numPinnedTabs = parseInt(safari.extension.settings.numPinnedTabs);

// Whether or not to skip delay for new tab
var noDelayForNewTab = true;

// Singleton for the event used to move the current tab after delay
var activationEvent = null;

// Move the given tab to the first position
var moveTab = function(tab) {
  console.log('Moving tab:', tab)
  tab.browserWindow.insertTab(tab, 0);
}

// Listener for "activate" events
var activateHandler = function(event) {

  // Filter to tab activation events
  if (Object.prototype.toString.call(event.target) === "[object SafariBrowserTab]") {

    // If there's an outstanding event, cancel and clear it
    if (activationEvent != null) {
      clearTimeout(activationEvent);
      activationEvent = null;
    }

    // Check if new tab (blank URL) should skip delay
    var millisecondsBeforeMoving = delay;
    if (noDelayForNewTab && event.target.url === "") {
      millisecondsBeforeMoving = 0;
    }

    // Schedule the activated tab to be moved
    var tab = event.target;
    var tab_position = tab.browserWindow.tabs.findIndex(function (item) { return item === tab; });

    if (tab_position < numPinnedTabs) {
      console.log('Don\'t moving this tab because it\'s position less than', numPinnedTabs);
    } else {
      activationEvent = setTimeout(
        function() {
            moveTab(tab);
        },
        millisecondsBeforeMoving);
    }
  }
}

// Register our listener for all "activate" events
safari.application.addEventListener("activate", activateHandler, true);

// Handler for changes to settings
function settingChanged(event) {
  console.log('Settings changed', event);
  var name = event.key;
  var value = event.newValue;
  var intSettings = ["delay", "numPinnedTabs"];

  if (intSettings.includes(name)) {
    // Only change value if setting is an integer
    value = parseInt(value);
    if (value != NaN) {
      window[name] = value;
    }
  } else {
    window[name] = value;
  }
}

// Register for any setting changes
safari.extension.settings.addEventListener("change", settingChanged, false);

   </script>
</head>
<body> </body>
</html>
